<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>All The Fishes</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
  </head>
  <body>
    <script>
      //The App
      const app = new PIXI.Application({
        width: 640,
        height: 480,
        backgroundColor: 0x151e3d,
      });

      //Give us the view
      document.body.appendChild(app.view);

      // Fish Tank

      // Seaweed

      const my_sprite = PIXI.Sprite.from('img/seaweed.png');
      my_sprite.scale.set(0.2);
      my_sprite.x = 60;
      my_sprite.y = 400;
      my_sprite.anchor.set(0.5);

      app.stage.addChild(my_sprite);

      const my_sprite2 = PIXI.Sprite.from('img/seaweed_2.png');
      my_sprite2.scale.set(0.1);
      my_sprite2.x = 550;
      my_sprite2.y = 424;
      my_sprite2.anchor.set(0.5);

      app.stage.addChild(my_sprite2);

      // Coral

      const my_sprite3 = PIXI.Sprite.from('img/coral.png');
      my_sprite3.scale.set(0.3);
      my_sprite3.x = 320;
      my_sprite3.y = 435;
      my_sprite3.anchor.set(0.5);

      app.stage.addChild(my_sprite3);

      // Anchor

      const my_sprite4 = PIXI.Sprite.from('img/anchor.png');
      my_sprite4.scale.set(0.1);
      my_sprite4.x = 450;
      my_sprite4.y = 405;
      my_sprite4.anchor.set(0.5);

      app.stage.addChild(my_sprite4);

      //Our fish
      const my_sprite5 = PIXI.Sprite.from('img/fish.png');
      my_sprite5.scale.set(0.2);
      my_sprite5.x = 100;
      my_sprite5.y = 250;
      my_sprite5.tint = 0xff0000;
      my_sprite5.anchor.set(0.5);

      app.stage.addChild(my_sprite5);

      //Fish 2

      const my_sprite6 = PIXI.Sprite.from('img/fish_2.png');
      my_sprite6.scale.set(0.1);
      my_sprite6.x = 520;
      my_sprite6.y = 270;
      my_sprite6.tint = 0xff00f0;
      my_sprite6.anchor.set(0.5);

      app.stage.addChild(my_sprite6);

      //Fish 3 - Draggable

      const my_sprite7 = PIXI.Sprite.from('img/fish_3.png');
      my_sprite7.scale.set(-0.2, 0.2);
      my_sprite7.x = 100;
      my_sprite7.y = 60;
      my_sprite7.tint = 0xffbf00;
      my_sprite7.anchor.set(0.5);

      app.stage.addChild(my_sprite7);

      //Fish 4

      const my_sprite8 = PIXI.Sprite.from('img/fish_4.png');
      my_sprite8.scale.set(0.3);
      my_sprite8.x = 500;
      my_sprite8.y = 150;
      my_sprite8.tint = 0x68ff00;
      my_sprite8.anchor.set(0.5);

      app.stage.addChild(my_sprite8);

      //Disco Ball

      const my_sprite9 = PIXI.Sprite.from('img/disco.png');
      my_sprite9.scale.set(0.1);
      my_sprite9.x = 300;
      my_sprite9.y = 50;
      my_sprite9.anchor.set(0.5);

      app.stage.addChild(my_sprite9);

      //Light 1

      const my_sprite10 = PIXI.Sprite.from('img/light.png');
      my_sprite10.scale.set(0.8);
      my_sprite10.x = 100;
      my_sprite10.y = 220;
      my_sprite10.tint = 0xff00f0;
      my_sprite10.anchor.set(0.5);

      app.stage.addChild(my_sprite10);

      //Light 2

      const my_sprite11 = PIXI.Sprite.from('img/light.png');
      my_sprite11.scale.set(0.8);
      my_sprite11.x = 300;
      my_sprite11.y = 220;
      my_sprite11.anchor.set(0.5);

      app.stage.addChild(my_sprite11);

      //Light 3

      const my_sprite12 = PIXI.Sprite.from('img/light.png');
      my_sprite12.scale.set(0.8);
      my_sprite12.x = 500;
      my_sprite12.y = 220;
      my_sprite12.tint = 0xff0000;
      my_sprite12.anchor.set(0.5);

      app.stage.addChild(my_sprite12);

      //Diver

      const my_sprite13 = PIXI.Sprite.from('img/diver.png');
      my_sprite13.scale.set(0.1);
      my_sprite13.x = 300;
      my_sprite13.y = 200;
      my_sprite13.anchor.set(0.5);

      app.stage.addChild(my_sprite13);

      // Create fish container

      const my_container = new PIXI.Container();

      // Create seaweed container

      const my_container2 = new PIXI.Container();

      // Create light container

      const my_container3 = new PIXI.Container();

      // Add containers to stage
      app.stage.addChild(my_container);
      app.stage.addChild(my_container2);
      app.stage.addChild(my_container3);

      // Add seaweed to container
      my_container2.addChild(my_sprite);
      my_container2.addChild(my_sprite2);

      // Add fish to container
      // my_container.addChild(my_sprite5);
      my_container.addChild(my_sprite6);

      // Add light to container
      my_container3.addChild(my_sprite10);
      my_container3.addChild(my_sprite11);
      my_container3.addChild(my_sprite12);

      let loop = () => {
        let time = Date.now();
        let wobble = Math.sin(time / 1000) * 50;

        my_container.y = wobble;

        requestAnimationFrame(loop);
      };

      let loop_2 = () => {
        let time = Date.now();
        let wobble = Math.sin(time / 1000) * 10;

        my_container2.x = wobble;

        requestAnimationFrame(loop_2);
      };

      let loop_3 = () => {
        let time = Date.now();
        let wobble = Math.sin(time / 1000) * 5;

        my_sprite4.angle = wobble;

        requestAnimationFrame(loop_3);
      };

      let loop_4 = () => {
        let time = Date.now();
        let wobble = Math.sin(time / 1000) * 40;

        my_sprite8.angle = wobble;

        // my_sprite8.tint = randomColor;

        requestAnimationFrame(loop_4);
      };

      let loop_5 = () => {
        let time = Date.now();
        let wobble = Math.sin(time / 1000) * 40;
        let wobble2 = Math.sin(time / 1000) * 80;

        my_sprite7.angle = wobble;

        // my_sprite7.x = wobble2;

        requestAnimationFrame(loop_5);
      };

      let loop_6 = () => {
        let time = Date.now();
        let wobble = Math.sin(time / 1000) * 100;

        my_container3.alpha = wobble;

        requestAnimationFrame(loop_6);
      };

      let loop_7 = () => {
        let time = Date.now();
        let wobble = Math.sin(time / 1000) * 300;

        my_sprite13.angle = wobble;

        requestAnimationFrame(loop_7);
      };

      loop();
      loop_2();
      loop_3();
      loop_4();
      loop_5();
      loop_6();
      loop_7();

      // Change Color Button

      function makeButton() {
        // Build a container
        let ourButton = new PIXI.Container();
        ourButton.interactive = true;

        // Create button body
        let buttonBody = new PIXI.Graphics();
        buttonBody.beginFill(0x000000);
        // buttonBody.drawRect(0, 0, 200, 100);
        buttonBody.drawRoundedRect(0, 0, 200, 95, 50);

        ourButton.addChild(buttonBody);

        ourButton.body = buttonBody;

        let buttonText = new PIXI.Text('Random Color');
        buttonText.anchor.set(0.5, 0.5);
        buttonText.x = buttonBody.width / 2;
        buttonText.y = buttonBody.height / 2;

        // Button styling

        buttonText.style.fill = 0xff00ff;
        buttonText.style.fontFamily = 'Georgia';

        ourButton.addChild(buttonText);

        ourButton.label = buttonText;

        ourButton.on('pointertap', (e) => {
          console.log(e);
          let color = 0xffffff * Math.random();
          // buttonBody.tint = color;
          my_sprite8.tint = color;
        });

        ourButton.on('pointerover', function (e) {
          ourButton.alpha = 0.8;
        });
        ourButton.on('pointerout', function (e) {
          ourButton.alpha = 1.0;
        });

        return ourButton;
      }

      // Draggable Fish

      function fishButton() {
        // Build a container
        let ourButton = new PIXI.Container();
        ourButton.interactive = true;

        // Create button body
        let buttonBody = my_sprite7;

        ourButton.addChild(buttonBody);

        ourButton.body = buttonBody;

        // Draggable event listeners
        ourButton.dragging = false;
        offsetX = 0;
        offsetY = 0;

        ourButton.on('pointerdown', function (e) {
          ourButton.dragging = true;
          offsetX = ourButton.x - e.data.global.x;
          offsetY = ourButton.y - e.data.global.y;
        });

        ourButton.on('pointermove', function (e) {
          if (ourButton.dragging) {
            console.log(e);
            ourButton.x = e.data.global.x + offsetX;
            ourButton.y = e.data.global.y + offsetY;
          }
        });

        ourButton.on('pointerup', function (e) {
          ourButton.dragging = false;
        });

        return ourButton;
      }

      let button = makeButton();
      button.x = 180;
      button.y = 360;

      app.stage.addChild(button);

      let dragFish = fishButton();
      dragFish.x = 30;
      dragFish.y = 20;

      app.stage.addChild(dragFish);

      // Slider

      function makeSlider() {
        //Container
        let ourButton = new PIXI.Container();
        ourButton.interactive = true;

        //Value from 0.0 to 1.0
        ourButton.value = 0;

        //The track
        let theTrack = new PIXI.Graphics();
        theTrack.beginFill(0x00FFFF);
        theTrack.drawRect(0, -10, 180, 20);

        ourButton.addChild(theTrack);

        //The slide
        let theSlide = new PIXI.Graphics();
        theSlide.interactive = true;
        theSlide.beginFill(0xFF10F0);
        theSlide.drawRect(-25, -25, 50, 50);

        ourButton.addChild(theSlide);

        //Add event listeners
        //Draggable event listeners
        //Draggin on or off
        theSlide.dragging = false;
        //Pointer down
        theSlide.on('pointerdown', function (e) {
          theSlide.dragging = true;
        });
        theSlide.on('pointermove', function (e) {
          if (theSlide.dragging) {
            let newX = e.data.global.x - ourButton.getGlobalPosition().x;
            let newY = e.data.global.y - ourButton.getGlobalPosition().y;

            /*
                console.log(
                        Math.round(e.data.global.x),
                        Math.round(e.data.global.y),
                        Math.round(newX), 
                        Math.round(newY),
                        ourButton.getGlobalPosition());
                */

            if (newX > theTrack.width) newX = theTrack.width;
            if (newX < 0) newX = 0;

            ourButton.value = newX / theTrack.width;

            theSlide.x = newX;

            my_sprite6.scale.set(ourButton.value/10);
            console.log(ourButton.value);
          }
        });
        //Pointer up
        theSlide.on('pointerup', function (e) {
          theSlide.dragging = false;
        });
        theSlide.on('pointerupoutside', function (e) {
          theSlide.dragging = false;
        });

        return ourButton;
      }

      let ourSlider = makeSlider();
      ourSlider.y = 300;
      ourSlider.x = 230;
      app.stage.addChild(ourSlider);

      // Animation System 

      let Animate = {};

      Animate.to = function(obj,end) {
        //Make it a promise:
        return new Promise( (resolve,reject) => {

            //Set up initial state parameters
            //We need to know where we started for this to work
            //Just x and y to start
            let start = {
                x : obj.x,
                y : obj.y,
                tint : obj.tint,  
                scale: obj.scale,
                alpha: obj.alpha,
                angle: obj.angle,
            }

            //Set some defaults
            if (end.duration == undefined) end.duration = 0;
            if (end.easing == undefined) end.easing = Animate.easeInOut;

            //We need to know when we've started animating
            var startTime = Date.now();

            //This will be our personal animation loop
            function loop() {

                //Calculate our delta
                let ticker = Date.now() - startTime;
                let delta = ticker/end.duration;
                let ease = end.easing(delta);

                //If we're done, just snap to the end!
                if (delta >= 1 || end.duration === 0) {
                    obj.x = end.x;
                    obj.y = end.y;
                    console.log("Done!");
                    
                    resolve();
                    return;
                }

                //Interpolation function
                let lerp = (a, b, n) => {
                    return (1 - n) * a + n * b;
                }

                //Interpolate (lerp) our x coordinate
                obj.x = lerp(start.x,end.x,ease);

                //Lerp our y coordinate
                obj.y = lerp(start.y,end.y,ease);

                // Tint 
                if (delta >= 1 || end.duration === 0) {
                    obj.tint = 0xffffff * Math.random();
                    console.log("Color Done!");
                    
                    resolve();
                    return;
                }

                // Scale 
                if (delta >= 1 || end.duration === 0) {
                    obj.scale.set(Math.random()/10);
                    console.log("Scale Done!");
                    
                    resolve();
                    return;
                }

                // Alpha 
                if (delta >= 1 || end.duration === 0) {
                    obj.alpha = (Math.random());
                    console.log("Alpha Done!");
                    
                    resolve();
                    return;
                }

                // Angle 
                if (delta >= 1 || end.duration === 0) {
                    let time = Date.now();
                    let wobble = Math.sin(time / 1000) * 100;
                    obj.angle = (wobble);
                    console.log("Wobble Done!");
                    
                    resolve();
                    return;
                }


                //Start the loop going!
                obj.animationID = requestAnimationFrame(loop);

            }
            //Clear the animation ID so there aren't competing loops
            cancelAnimationFrame(obj.animationID);

            //Begin the loop!
            loop();
        //End Promise
        });

      };

      Animate.from = async function(obj,end) {
        end.duration = 0;
        Animate.to(obj,end);
      };

      Animate.easeInOut = (x) => x < 0.5 ? 2 * x * x : 1 - Math.pow(-2 * x + 2, 2) / 2; //Yay math!

      let moveAround = async () => {
        Animate.from( bobFish,{x:100,y:200});
        await Animate.to( bobFish,{x:100,y:240,duration:2000});
        await Animate.to( bobFish,{x:100,y:200,duration:2000});
        moveAround();
      };

      let swimUp = async () => {
        Animate.from( my_sprite5,{x:10,y:200});
        await Animate.to( my_sprite5,{x:300,y:-180,duration:4000});
        await Animate.to( my_sprite5,{x:10,y:200,duration:3000});
      }

      // Idle Swimming Fish
      function fishSwim() {
        // Build a container
        let ourButton = new PIXI.Container();
        ourButton.interactive = true;

        // Create button body
        let buttonBody = my_sprite5;

        ourButton.addChild(buttonBody);

        ourButton.body = buttonBody;

        ourButton.on('pointertap', (e) => {
          console.log(e);
          swimUp();
        });

        return ourButton;
      }

      let bobFish = fishSwim();
      // bobFish.x = 0;
      // bobFish.y = 0;

      app.stage.addChild(bobFish);

      moveAround();

      

      
    </script>
  </body>
</html>
